
# @shangxueink/koishi-plugin-keyword-dialogue

[![npm](https://img.shields.io/npm/v/@shangxueink/koishi-plugin-keyword-dialogue?style=flat-square)](https://www.npmjs.com/package/@shangxueink/koishi-plugin-keyword-dialogue)


🤖 本插件用于在聊天机器人中设置关键词回复。

你可以定义特定的关键词，当用户输入这些关键词时，机器人会给出预设的回复。

此外，该插件还支持全局关键词和正则表达式匹配，以及图片下载和多段回复功能。

## 功能特色
- 📝 **关键词回复**：设置特定关键词和对应的回复内容。
- 🌐 **全局关键词**：设置全局范围内有效的关键词回复。
- 🛠️ **正则匹配**：支持通过正则表达式匹配用户输入。
- 🖼️ **图片下载**：能够下载用户提供的图片链接，并保存到本地。
- 📝 **多段回复**：支持多段回复内容，可以按原始格式发送或合并为一条消息。
## 配置项说明
### 基础设置
- `TriggerPrefix`: 触发添加关键词的指令前缀，默认为“添加”。
- `DeleteKeyword`: 触发删除关键词的指令前缀，默认为“删除”。
- `KeywordOfEnd`: 退出添加关键词功能的关键词，默认为“结束添加”。
- `GlobalTriggerPrefix`: 触发全局添加关键词的指令前缀，默认为“全局添加”。
- `GlobalDeleteKeyword`: 触发全局删除关键词的指令前缀，默认为“全局删除”。
- `defaultImageExtension`: 输入图片保存的后缀名，默认为“png”。
### 进阶设置
- `Prompt`: 添加关键词时返回的文字提示，默认为“请输入回复内容（输入结束添加以退出）：”。
- `MatchPatternForExit`: 如何退出添加关键词模式，默认为包含关键词即可退出。
- `AlwayPrompt`: 是否总是返回提示，默认为仅返回一次提示。
- `HandleDuplicateKeywords`: 如何处理重复添加的关键词，默认为不允许添加重复内容。
- `MultisegmentAdditionRecoveryEffect`: 多段添加的回复效果，默认为合为一条消息。
### 调试设置
- `consoleInfo`: 是否开启日志调试模式，默认为关闭。


## 安装与使用
1. 将本插件安装到你的 Koishi 项目中。
2. 设置所需的配置项。
3. 开启插件即可啦~

## 使用方法

### 添加关键词回复

使用命令格式：`添加 <关键词> [-x]`
- `<关键词>`: 要添加的关键词
- `-x`: 可选，表示关键词为正则表达式
例如：
```bash
添加 你好啊
添加 你好啊 -x
```
### 删除关键词回复
使用命令格式：`删除 <关键词>`
- `<关键词>`: 要删除的关键词（支持删除正则表达式关键词）
例如：
```bash
删除 你好啊
```

## 注意事项
- 请确保你的 Koishi 机器人拥有足够的权限来保存图片和读取配置文件。
- 本插件使用 JSON 文件来存储关键词和回复数据，请注意数据备份。
- 如果需要使用图片功能，请确保你的环境支持 Node.js 的文件系统操作。

<details>
<summary>点击此处————查看更新日志</summary>

-  **0.6.3**
    -   优化添加关键词的写入，防止正则表达式出错，避免引发未终止的组错误

-  **0.6.2**
    -   优化`查找关键词`指令，确保搜索结果的实时性
    -   修改`Search_Range`配置项默认值为`1`
    -   提取 `formatReply` 为单独函数，方便调用
    -   优化`查找关键词`指令返回方法，不再返回文本化的元素消息，而是unescape后的内容（即，把只会返回图片链接，优化为发送图片）
    -   优化`Prompt`配置项为多行文本配置项，方便编辑文字。

-  **0.6.1**
    -   进一步兼容喵喵插件的json
    -   优化图片回复type字段为image，兼容处理img
    -   完善package.json反馈地址

-  **0.6.0**
    -   重构`middlewareFunction`中间件函数
    -   优化日志输出函数，避免代码重复
    -   修复**0.5.2**`新增audio、video类型消息支持`带来的回复bug
    -   回复方式新增合并转发选项

-  **0.5.4**
    -   新增图片保存方式与发送方式
    -   修改`combinedReply`作用域
    -   修复`MultisegmentAdditionRecoveryEffect`为第一项时不回复的bug。

-  **0.5.2**
    -   移除marketface类型消息
    -   新增audio、video类型消息支持
    -   优化屏蔽触发的日志输出
    -   修复`搜索关键词`指令配置项不生效的bug
    -   优化控制台说明文字
    -   调整默认触发间隔为`0`

-  **0.4.1**
    -   新增回复频率限制的功能
    -   修复一次性输入的写入bug

-  **0.4.0**
    -   新增 `config.Preposition_middleware` 配置项。
    -   当 `config.Preposition_middleware` 设置为 `true` 时，启用前置中间件。前置中间件在捕获消息后可以决定是否继续传递消息给其他中间件，从而实现“指令维护”功能。
    -   当 `config.Preposition_middleware` 设置为 `false` 时，使用普通中间件，保持原有行为。
    -   将中间件逻辑抽取为 `middlewareFunction`，提高代码可读性和可维护性。
    -   根据 `config.Preposition_middleware` 的值动态注册中间件或前置中间件，增强灵活性。  

-  **0.3.9**
    -   修改部分配置项的默认值

-  **0.3.8**
    -   新增查找关键词功能

-  **0.3.7** 
    -   新增`picture_save_to_local`配置项，允许用户自行决定是否保存图片
    -   修复消息元素转义，使关键词更易懂
    -   对中间件匹配优化，使用`.trim()`以使 `关键词` 与 `     关键词       ` 输入效果一致

-  **0.3.6** 
    -   优化文件保存路径
    -   本地化支持

-  **0.3.4** 
    -   新增父级指令
    -   优化插件的说明文字
    -   新增`取消添加`功能
    -   新增`大小写英文等同`的模式开关
    -   新增`仅允许管理员操作`的模式开关

-  **0.3.2** 
    -   修复`全局添加`时，更改图片保存文件夹为`global`文件夹
    -   增加对`数据文件夹`的位置说明与修改说明

-  **0.3.1** 
    -   优化中间件等待时间，允许通过配置项自定义
    -   优化插件控制台展示内容

- **0.2.3** 
    -   优化对于`mface`等元素的回复支持
    -   优化对于输入的匹配，优化字符转义带来的匹配问题

- **0.2.1** 
    -   优化`添加`指令的`-x`选项失效的问题
    -   修复对于正则关键词无响应的情况
    -   完善README说明内容

</details>
